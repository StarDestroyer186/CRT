function MapClassImpl(t, e, i, o, n, a) {
  (this.opts_poly = {
    strokeColor: e.lineColor || "#f00",
    strokeOpacity: e.lineOpacity || 0.8,
    strokeWeight: e.lineWidth || 3,
    strokeMovesWeight: e.lineMovesWidth || 8,
    strokeMovesColor: "green",
    point: !0,
  }),
    (this.history = n),
    (this.trackpts = []),
    (this.showingMarkers = []),
    (this.lastMarker = null),
    (this.animationMarker = []),
    this.markerCluster,
    (this.isClusters = !0),
    (this.isShowMarkers = !1),
    (this.isShowLabels = !0),
    (this.isShowStops = !0),
    (this.isShowEvents = !0),
    (this.isShowAngles = !0),
    (this.isShowTimes = !1),
    (this.isNavigation = !1),
    (this.isRoute = !0),
    (this.isSnap = !1),
    (this.isSnaping = !1),
    (this.isShowDriver = !1),
    (this.anglePoints = []),
    (this.timePoints = []),
    (this.stopPoints = []),
    (this.eventPoints = []),
    (this.averagePoints = []),
    (this.startMarker = null),
    (this.endMarker = null),
    (this.router = new L.Routing.osrmv1({
      serviceUrl: JS_ROUTING_MACHINE_URL,
    })),
    (this.routing = null),
    (this.routingSnapControl = null),
    (this.routingSnapRoute = null),
    (this.tracklatLngs = []),
    (this.taskPath = null),
    (this.currentZoom = e.zoom),
    (this.def_save_points = 50);
  var r = window.parent;
  if (1 == o || 1 == n) {
    var s = $('<div id="legdiv" />').appendTo(t),
      l = $("<tbody></tbody>").appendTo(s),
      p = $("<tr></tr>").appendTo(l);
    $("<td width='50'></td>").text(0).appendTo(p),
      $("<td width='50'></td>").text(40).appendTo(p),
      $("<td width='50'></td>").text(80).appendTo(p),
      $("<td width='50'></td>").text(90).appendTo(p),
      $("<td width='50'></td>")
        .text("120" + r.UNIT_SPEED)
        .appendTo(p);
    var d = $("<tr></tr>").appendTo(l);
    $("<td height='8' bgcolor='#5DFEFE'></td>").appendTo(d),
      $("<td height='8' bgcolor='#0096FE'></td>").appendTo(d),
      $("<td height='8' bgcolor='#3200FF'></td>").appendTo(d),
      $("<td height='8' bgcolor='#9A009C'></td>").appendTo(d),
      $("<td height='8' bgcolor='#FF002A'></td>").appendTo(d);
  }
  if (1 == o) {
    var h = $('<div id="maptools" />').appendTo(t.parentElement),
      g = ((l = $("<table></table>").appendTo(h)), $("<tr></tr>").appendTo(l));
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_asset' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_object-arrow.svg'/></td>"
    ).appendTo(g);
    var c = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_fit' class='tool_active' height='50%' width='50%' src='../img/tool_fit_assets.svg'/></td>"
    ).appendTo(c);
    var u = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_label' class='tool_active' height='50%' width='50%' src='../img/tool_tips.svg'/></td>"
    ).appendTo(u);
    var m = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_driver' style='opacity: 0.5' height='50%' width='50%' src='../img/steering_wheel_green.svg'/></td>"
    ).appendTo(m);
    var v = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_marker' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_markers.svg'/></td>"
    ).appendTo(v);
    var y = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_zone' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_zones.svg'/></td>"
    ).appendTo(y);
    var f = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_clusters' class='tool_active' height='50%' width='50%' src='../img/tool_clusters.svg'/></td>"
    ).appendTo(f);
    var w = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_measure' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_caliper.svg'/></td>"
    ).appendTo(w);
    var T = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_ruler' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_ruler.svg'/></td>"
    ).appendTo(T);
    var x = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_navigation' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_navigation.svg'/></td>"
    ).appendTo(x);
    var _ = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_street_view' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_streetview.svg'/></td>"
    ).appendTo(_);
    var b = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_task' style='opacity: 0.5' height='50%' width='50%' src='../img/tasknew.svg'/></td>"
    ).appendTo(b);
  } else if (0 == o && 1 == n) {
    (h = $(
      '<div id="maptools" style="left: 316px; top: 110px; z-index: 1000;" />'
    ).appendTo(t.parentElement)),
      (l = $("<table></table>").appendTo(h)),
      (c = $("<tr></tr>").appendTo(l));
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_label' class='tool_active' height='50%' width='50%' src='../img/tool_tips.svg'/></td>"
    ).appendTo(c);
    b = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_driver' style='opacity: 0.5' height='50%' width='50%' src='../img/steering_wheel_green.svg'/></td>"
    ).appendTo(b);
    u = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_marker' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_markers.svg'/></td>"
    ).appendTo(u);
    v = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_zone' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_zones.svg'/></td>"
    ).appendTo(v);
    m = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_measure' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_caliper.svg'/></td>"
    ).appendTo(m);
    var k = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_ruler' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_ruler.svg'/></td>"
    ).appendTo(k);
    y = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_arrow' class='tool_active' height='50%' width='50%' src='../img/tool_arrow.svg'/></td>"
    ).appendTo(y);
    f = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_point' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_point.svg'/></td>"
    ).appendTo(f);
    w = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_stop' class='tool_active' height='50%' width='50%' src='../img/tool_stop.svg'/></td>"
    ).appendTo(w);
    T = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_event' class='tool_active' height='50%' width='50%' src='../img/tool_event.svg'/></td>"
    ).appendTo(T);
    x = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_route' class='tool_active' height='50%' width='50%' src='../img/tool_route.svg'/></td>"
    ).appendTo(x);
    _ = $("<tr></tr>").appendTo(l);
    $(
      "<td align='center' height='28px' width='28px' bgcolor='#FFFFFF'><img id='ed_snap' style='opacity: 0.5' height='50%' width='50%' src='../img/tool_snap.svg'/></td>"
    ).appendTo(_);
  }
  var S,
    M,
    F,
    A,
    P,
    E = L.tileLayer("https://{s}.tile.osm.org/{z}/{x}/{y}.png", {
      id: "mapbox.light",
      minZoom: 2,
      maxZoom: 20,
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }),
    C = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
      {
        minZoom: 2,
        maxZoom: 19,
        attribution:
          "Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community",
      }
    ),
    D = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        minZoom: 2,
        maxZoom: 19,
        attribution:
          "Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
      }
    );
  0 == JS_GOOGLE_TYPE
    ? ((S = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=m&hl=" +
          JS_CURRENT_LANG +
          "&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Streets",
        }
      )),
      (M = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=s,h&hl=" +
          JS_CURRENT_LANG +
          "&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Hybrid",
        }
      )),
      (F = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=s&hl=" +
          JS_CURRENT_LANG +
          "&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Satellite",
        }
      )),
      (A = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=p&hl=" +
          JS_CURRENT_LANG +
          "&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Terrain",
        }
      )),
      (P = L.tileLayer(
        "https://{s}.google.com/vt/lyrs=m@159000000,traffic|seconds_into_week:-1&hl=" +
          JS_CURRENT_LANG +
          "&x={x}&y={y}&z={z}",
        {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "Google Traffic",
        }
      )))
    : ((S = L.gridLayer.googleMutant({ maxZoom: 24, type: "roadmap" })),
      (M = L.gridLayer.googleMutant({ maxZoom: 24, type: "hybrid" })),
      (F = L.gridLayer.googleMutant({ maxZoom: 24, type: "satellite" })),
      (A = L.gridLayer.googleMutant({ maxZoom: 24, type: "terrain" })),
      (P = L.gridLayer.googleMutant({
        maxZoom: 24,
        type: "roadmap",
      })).addGoogleLayer("TrafficLayer"));
  var I = L.tileLayer(
      "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",
      { maxZoom: 20, id: "mapbox/streets-v11", accessToken: JS_MAPBOX_KEY }
    ),
    G = L.tileLayer(
      "https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",
      { maxZoom: 20, id: "mapbox.satellite", accessToken: JS_MAPBOX_KEY }
    ),
    N =
      (new L.tileLayer.baidu({ layer: "vec" }),
      new L.tileLayer.baidu({ layer: "img" }),
      L.tileLayer(
        "http://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",
        { maxZoom: 20, minZoom: 2, subdomains: ["1", "2", "3", "4"] }
      )),
    O = new L.BingLayer(JS_BING_KEY, {
      type: "RoadOnDemand",
      minZoom: 2,
      maxZoom: 20,
    }),
    R = new L.BingLayer(JS_BING_KEY, {
      type: "AerialWithLabels",
      minZoom: 2,
      maxZoom: 20,
    }),
    z = L.tileLayer("http://tiles.openseamap.org/seamark/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution:
        'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors',
    }),
    J = L.tileLayer(
      "https://{s}.tile.maps.openaip.net/geowebcache/service/tms/1.0.0/openaip_basemap@EPSG%3A900913@png/{z}/{x}/{y}.{ext}",
      {
        attribution:
          '<a href="https://www.openaip.net/">openAIP Data</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-NC-SA</a>)',
        ext: "png",
        minZoom: 2,
        maxZoom: 20,
        tms: !0,
        detectRetina: !0,
        subdomains: "12",
      }
    ),
    Z = L.tileLayer(
      "https://map1.vis.earthdata.nasa.gov/wmts-webmerc/MODIS_Terra_Chlorophyll_A/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}",
      {
        attribution:
          'Imagery provided by services from the Global Imagery Browse Services (GIBS), operated by the NASA/GSFC/Earth Science Data and Information System (<a href="https://earthdata.nasa.gov">ESDIS</a>) with funding provided by NASA/HQ.',
        bounds: [
          [-85.0511287776, -179.999999975],
          [85.0511287776, 179.999999975],
        ],
        minZoom: 1,
        maxZoom: 7,
        format: "png",
        time: "",
        tilematrixset: "GoogleMapsCompatible_Level",
        opacity: 0.75,
      }
    ),
    U = L.tileLayer(
      "https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png",
      {
        maxZoom: 20,
        attribution:
          'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Map style: &copy; <a href="https://www.OpenRailwayMap.org">OpenRailwayMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
      }
    );
  this.wndMap = L.map(t, {
    editable: !0,
    center: [e.centerLat, e.centerLng],
    zoom: 1,
    minZoom: 2,
    maxZoom: 20,
    attributionControl: !1,
    bounceAtZoomLimits: !1,
    layers: [S],
    fullscreenControl: !0,
    fullscreenControlOptions: {
      position: "topleft",
      title: JS_FULL_SCREEN,
      forceSeparateButton: !1,
      forcePseudoFullscreen: !0,
    },
    preferCanvas: !(
      -1 != navigator.userAgent.toLowerCase().indexOf("safari") &&
      -1 == navigator.userAgent.toLowerCase().indexOf("chrome")
    ),
  });
  var B = this.wndMap,
    W = {
      "Google Streets": S,
      "Google Hybrid": M,
      "Google Satellite": F,
      "Google Terrain": A,
      "Google Traffic": P,
      OSM: E,
      "Bing Road": O,
      "Bing Aerial": R,
      "Mapbox Streets": I,
      "Mapbox Satellite": G,
      "Esri WorldTopoMap": C,
      "Esri WorldImagery": D,
      高德地图: N,
    },
    H = {
      "OpenSea Layer": z,
      "OpenAIP Layer": J,
      "NASAGIBS Layer": Z,
      "Open Railway Layer": U,
    };
  L.control.layers(W, H, { collapsed: !0 }).addTo(B);
  var K = this;
  (this.markerCluster = L.markerClusterGroup({
    animate: !0,
    animateAddingMarkers: !0,
    removeOutsideVisibleBounds: !0,
    disableClusteringAtZoom: 20,
    maxClusterRadius: 80,
    iconCreateFunction: function (t) {
      var e = t.getAllChildMarkers(),
        i = e.length,
        o = (function (t) {
          if (!t.data || !t.valueFunc) return "";
          var e = t.data,
            i = t.valueFunc,
            o = t.outerRadius ? t.outerRadius : 28,
            n = t.innerRadius ? t.innerRadius : o - 10,
            a = t.strokeWidth ? t.strokeWidth : 1,
            r = t.pathClassFunc
              ? t.pathClassFunc
              : function () {
                  return "";
                },
            s = t.pathTitleFunc
              ? t.pathTitleFunc
              : function () {
                  return "";
                },
            l = t.pieClass ? t.pieClass : "marker-cluster-pie",
            p = t.pieLabel ? t.pieLabel : d3.sum(e, i),
            d = t.pieLabelClass ? t.pieLabelClass : "marker-cluster-pie-label",
            h = o + a,
            g = 2 * h,
            c = g,
            u = d3.layout.pie(),
            m = d3.svg.arc().innerRadius(n).outerRadius(o),
            v = document.createElementNS(d3.ns.prefix.svg, "svg"),
            y = d3
              .select(v)
              .data([e])
              .attr("class", l)
              .attr("width", g)
              .attr("height", c);
          return (
            y
              .selectAll("g.arc")
              .data(u.value(i))
              .enter()
              .append("svg:g")
              .attr("class", "arc")
              .attr("transform", "translate(" + h + "," + h + ")")
              .append("svg:path")
              .attr("class", r)
              .attr("stroke-width", a)
              .attr("d", m)
              .append("svg:title")
              .text(s),
            y
              .append("circle")
              .attr("cx", h)
              .attr("cy", h)
              .attr("r", 12)
              .attr("fill", "#F1F1F1"),
            y
              .append("text")
              .attr("x", h)
              .attr("y", h)
              .attr("class", d)
              .attr("text-anchor", "middle")
              .attr("dy", ".3em")
              .text(p),
            (L = v),
            void 0 !== window.XMLSerializer
              ? new window.XMLSerializer().serializeToString(L)
              : void 0 !== L.xml
              ? L.xml
              : ""
          );
          var L;
        })({
          data: d3
            .nest()
            .key(function (t) {
              return t.properties.mt;
            })
            .entries(e, d3.map),
          valueFunc: function (t) {
            return t.values.length;
          },
          strokeWidth: 1,
          outerRadius: 20,
          innerRadius: 12,
          pieClass: "cluster-pie",
          pieLabel: i,
          pieLabelClass: "marker-cluster-pie-label",
          pathClassFunc: function (t) {
            return "category-" + t.data.key;
          },
        });
      return new L.DivIcon({
        html: o,
        className: "marker-cluster",
        iconSize: new L.Point(42, 42),
      });
    },
  })),
    B.addLayer(this.markerCluster),
    this.markerCluster.on("animationend", function (t) {
      K.StopAnimationMarker(!0);
    }),
    this.markerCluster.on("clustermouseover", function (t) {
      var e = t.layer.getAllChildMarkers();
      ($popupTable = $('<table class="tree_table"><table>')),
        (l = $("<tbody></tbody>").appendTo($popupTable));
      e.forEach(function (t) {
        var e = t.properties.sta,
          i = t.properties.io,
          o = t.properties.st;
        ($tr = $("<tr></tr>").appendTo(l)),
          ($td = $(
            '<td style="font-weight: bold;">' +
              (t.properties.title.length > 20
                ? t.properties.title.substring(0, 20) + "..."
                : t.properties.title) +
              "</td>"
          ).appendTo($tr)),
          ($td = $(
            '<td style="white-space:nowrap;">' +
              t.properties.s +
              " " +
              r.UNIT_SPEED +
              "</td>"
          ).appendTo($tr)),
          "0" != e
            ? null != typeof o && null != o && o.indexOf("3005") >= 0
              ? ($td = $("<td></td>")
                  .attr("class", "engine_on")
                  .attr("title", r.JS_ENGINE_ON)
                  .appendTo($tr))
              : null != typeof o &&
                null != o &&
                o.indexOf("3006") >= 0 &&
                null != t.properties.s &&
                t.properties.s > 0
              ? ($td = $("<td></td>")
                  .attr("class", "engine_off")
                  .attr("title", r.JS_ENGINE_OFF)
                  .appendTo($tr))
              : ($td = $("<td></td>")
                  .attr("class", "parking")
                  .attr("title", r.JS_PARKING)
                  .appendTo($tr))
            : ($td = $("<td></td>").appendTo($tr)),
          ($td =
            "0" == e
              ? $("<td></td>")
                  .attr("class", "offline")
                  .attr("title", r.JS_TIP_OBJ_OFFLINE)
                  .appendTo($tr)
              : $("<td></td>")
                  .attr("class", "online")
                  .attr("title", r.JS_TIP_OBJ_ONLINE)
                  .appendTo($tr));
        var n = getIdValue("62:", i, !0);
        null != typeof n && null != n
          ? ($td =
              "0" == n
                ? $("<td></td>")
                    .attr("class", "gpsvalid")
                    .attr("title", r.JS_GPS_VALID)
                    .appendTo($tr)
                : $("<td></td>")
                    .attr("class", "cellvalid")
                    .attr("title", r.JS_LBS_VALID)
                    .appendTo($tr))
          : null != typeof o && o.indexOf("200E") >= 0
          ? ($td = $("<td></td>")
              .attr("class", "gpsvalid")
              .attr("title", r.JS_GPS_VALID)
              .appendTo($tr))
          : ($td = $("<td></td>")
              .attr("class", "invalid")
              .attr("title", r.JS_LOCATION_INVALID)
              .appendTo($tr));
      });
      L.popup({ offset: new L.Point(0, -10), minWidth: 220, maxHeight: 200 })
        .setLatLng(t.latlng)
        .setContent($popupTable.prop("outerHTML"))
        .openOn(B);
    });
  (this.polylineDecoratorLayer = []), (this.anglePointsLayer = L.layerGroup());
  var V = this.anglePointsLayer;
  this.timePointsLayer = L.layerGroup();
  var q = this.timePointsLayer;
  this.stopPointsLayer = L.layerGroup();
  var j = this.stopPointsLayer;
  this.eventPointsLayer = L.layerGroup();
  var Y = this.eventPointsLayer;
  if (
    (B.addLayer(V),
    B.addLayer(q),
    B.addLayer(j),
    B.addLayer(Y),
    B.on("zoomstart", function () {
      this.currentZoom = B.getZoom();
    }),
    B.on("zoomend", function () {
      this.currentZoom > B.getZoom()
        ? K.StopAnimationMarker(!1, !0)
        : K.StopAnimationMarker(!1, !1),
        B.getZoom() < 16 ? B.removeLayer(V) : K.isShowAngles && B.addLayer(V),
        B.getZoom() < 12 ? B.removeLayer(q) : K.isShowTimes && B.addLayer(q);
    }),
    B.on("enterFullscreen", function () {
      $("#maptools, #assetinfo, #stasep").css("display", "none");
    }),
    B.on("exitFullscreen", function () {
      $("#maptools, #stasep").css("display", "block"),
        $("#staswitch").hasClass("hide_status") ||
          $("#assetinfo").css("display", "block");
    }),
    B.on("moveend", function () {
      K.StopAnimationMarker(!1);
    }),
    B.on("popupopen", function (t) {
      console.log("popupopen");
      var e = t.popup._source;
      if (
        null != e &&
        null != e.properties &&
        void 0 !== e.properties.jb &&
        void 0 !== e.properties.n
      ) {
        var i = a[e.properties.jb];
        if (i) {
          var o = i.img,
            n = i.name;
          $(".infowindow .infodriver ul #idrvdef_" + e.properties.n).html(o),
            $(".infowindow .infodriver ul #ndrvdef" + e.properties.n).text(n);
        }
      }
    }),
    1 == i)
  ) {
    var X,
      Q = $('<div id="mapsearchbar" />').appendTo(t);
    $('<input type="text" id="mapsearchtext" />')
      .appendTo(Q)
      .keyup(function (t) {
        if ("13" == t.keyCode) {
          null != X && null != B && B.removeLayer(X);
          var e = $("#mapsearchtext").val();
          if ("" != e) {
            var i = e.split(",");
            if (2 != i.length || isNaN(i[0]) || isNaN(i[1])) {
              L.Control.Geocoder.nominatim().geocode(e, function (t) {
                if (
                  "undefined" != t &&
                  t.length > 0 &&
                  "undefined" != t[0].center
                ) {
                  var e = t[0].center.lat,
                    i = t[0].center.lng;
                  (X = L.marker([e, i])
                    .bindPopup(e + "," + i, { offset: new L.Point(0, -10) })
                    .openPopup()
                    .bindTooltip(t[0].name, {
                      permanent: !0,
                      offset: L.point(0, -42),
                      direction: "center",
                    })
                    .addTo(B)),
                    B.setView(X.getLatLng(), 18);
                } else alert("not found");
              });
            } else {
              var o = parseFloat(i[0]),
                n = parseFloat(i[1]);
              (X = L.marker([o, n])
                .bindPopup(o + "," + n, { offset: new L.Point(0, -10) })
                .openPopup()
                .bindTooltip(e, {
                  permanent: !0,
                  offset: L.point(0, -42),
                  direction: "center",
                })
                .addTo(B)),
                B.setView(X.getLatLng(), 18);
            }
          }
        }
      });
  }
  var tt = {
    points: [],
    color: "#3388FF",
    layers: L.layerGroup(),
    polygon: null,
    init: function () {
      tt.destroy(),
        (tt.points = []),
        (tt.polygon = null),
        tt.layers.addTo(B),
        B.on("click", tt.click).on("dblclick", tt.dblclick);
    },
    close: function () {
      var t = rectangleMeasure.tips.getLabel(),
        e = document.createTextNode(rectangleMeasure.tips.getLabel()._content);
      (t._container.innerHTML = ""), t._container.appendChild(e);
      var i = document.createElement("span");
      (i.innerHTML = "【关闭】"),
        (i.style.color = "#00ff40"),
        t._container.appendChild(i),
        L.DomEvent.addListener(i, "click", function () {
          rectangleMeasure.destroy();
        });
    },
    click: function (t) {
      B.doubleClickZoom.disable(),
        tt.points.push(t.latlng),
        B.on("mousemove", tt.mousemove);
    },
    mousemove: function (t) {
      tt.points.push(t.latlng),
        tt.polygon && tt.layers.removeLayer(tt.polygon),
        (tt.polygon = L.polygon(tt.points, {
          showMeasurements: !0,
          color: "#3388FF",
        }));
      try {
        tt.polygon.addTo(tt.layers);
      } catch (t) {}
      tt.points.pop();
    },
    dblclick: function (t) {
      tt.polygon &&
        (tt.polygon.addTo(tt.layers),
        tt.polygon.enableEdit(),
        B.on(
          "editable:vertex:drag editable:vertex:deleted",
          tt.polygon.updateMeasurements,
          tt.polygon
        )),
        B.off("click", tt.click)
          .off("mousemove", tt.mousemove)
          .off("dblclick", tt.dblclick);
    },
    destroy: function () {
      tt.layers && tt.polygon && tt.layers.removeLayer(tt.polygon),
        B.removeLayer(tt.layers);
    },
  };
  this.areaMeasure = tt;
  var et = L.control
    .measure({
      keyboard: !1,
      activeKeyCode: "M".charCodeAt(0),
      cancelKeyCode: 27,
      lineColor: "#3388FF",
      lineWeight: 3,
      lineDashArray: "6, 6",
      lineOpacity: 1,
      formatDistance: function (t) {
        return 1 == JS_UNIT_DISTANCE
          ? Math.round((1e3 * t) / 1609.344) / 1e3 + "mile"
          : t < 1e3
          ? Math.round(t) + "m"
          : Math.round((t / 1e3) * 100) / 100 + "km";
      },
    })
    .addTo(B);
  if (((this.distMeasure = et), 1 == o)) {
    function it(t, e) {
      var i = L.DomUtil.create("button", "", e);
      return i.setAttribute("type", "button"), (i.innerHTML = t), i;
    }
    this.routing = L.Routing.control({
      router: this.router,
      waypoints: [],
      routeWhileDragging: !0,
      attributionControl: !0,
      addWaypoints: !1,
      collapsible: !0,
      geocoder: L.Control.Geocoder.nominatim(),
      show: !1,
      units: 1 == JS_UNIT_DISTANCE ? "imperial" : "metric",
    }).addTo(this.wndMap);
    var ot = this.routing,
      nt = ((B = this.wndMap), this);
    this.wndMap.on("click", function (t) {
      if (nt.isNavigation) {
        var e = L.DomUtil.create("div"),
          i = it(JS_NAVIGATION_START, e),
          o = it(JS_NAVIGATION_END, e);
        L.popup().setContent(e).setLatLng(t.latlng).openOn(B),
          L.DomEvent.on(i, "click", function () {
            ot.setWaypoints([t.latlng]), B.closePopup();
          }),
          L.DomEvent.on(o, "click", function () {
            ot.spliceWaypoints(ot.getWaypoints().length - 1, 1, t.latlng),
              B.closePopup();
          });
      }
    });
  }
}
MapClassImpl.prototype = {
  getDirPoint: function (t) {
    switch (Math.round(t / 45)) {
      case 1:
        return { x: 30, y: 0 };
      case 2:
        return { x: 30, y: 15 };
      case 3:
        return { x: 30, y: 30 };
      case 4:
        return { x: 15, y: 30 };
      case 5:
        return { x: 0, y: 30 };
      case 6:
        return { x: 0, y: 15 };
      case 7:
        return { x: 0, y: 0 };
      default:
        return { x: 15, y: 0 };
    }
  },
  getDirPath: function (t) {
    switch (Math.round(t / 45)) {
      case 1:
        return "../img/locate/d1.png";
      case 2:
        return "../img/locate/d2.png";
      case 3:
        return "../img/locate/d3.png";
      case 4:
        return "../img/locate/d4.png";
      case 5:
        return "../img/locate/d5.png";
      case 6:
        return "../img/locate/d6.png";
      case 7:
        return "../img/locate/d7.png";
      default:
        return "../img/locate/d0.png";
    }
  },
  createButton: function (t, e) {
    var i = L.DomUtil.create("button", "", e);
    return i.setAttribute("type", "button"), (i.innerHTML = t), i;
  },
  ActiveNavigationTool: function (t) {
    (this.isNavigation = t),
      t
        ? this.routing.show()
        : (this.routing.spliceWaypoints(0, 2), this.routing.hide());
  },
  ActiveTaskPathTool: function (t, e, i) {
    if (t) {
      var o = [L.latLng(e[0][0], e[0][1]), L.latLng(e[1][0], e[1][1])],
        n = L.Control.Geocoder.nominatim();
      (this.taskPath = L.Routing.control({
        router: this.router,
        waypoints: o,
        routeWhileDragging: !1,
        attributionControl: !0,
        addWaypoints: !1,
        collapsible: !0,
        geocoder: n,
        show: !1,
        units: 1 == JS_UNIT_DISTANCE ? "imperial" : "metric",
        plan: L.Routing.plan(o, {
          createMarker: function (t, e) {
            if (o[0])
              return L.marker(e.latLng, { draggable: !1 }).bindTooltip(i[t], {
                permanent: !0,
                offset: L.point(0, 0),
                direction: "bottom",
              });
          },
        }),
      }).addTo(this.wndMap)),
        this.taskPath.show();
    } else
      null != this.taskPath &&
        void 0 !== this.taskPath &&
        (this.taskPath.spliceWaypoints(0, 2), this.taskPath.hide());
  },
  ActiveMeasureTool: function (t) {
    t ? this.areaMeasure.init() : this.areaMeasure.destroy();
  },
  ActiveRulerTool: function (t) {
    t ? this.distMeasure._startMeasuring() : this.distMeasure._stopMeasuring();
  },
  AddEvent: function (t, e) {
    this.wndMap.on(t, e);
  },
  Free: function () {
    (this.trackpts = null), (this.wndMap = null);
  },
  Center: function (t, e, i) {
    this.wndMap.panTo(new L.LatLng(t, e)), 0 != i && this.wndMap.setZoom(i);
  },
  Zoom: function (t) {
    0 != t && this.wndMap.setZoom(t);
  },
  GetMap: function () {
    return this.wndMap;
  },
  GeoNames: function (x, y, element, style, geocoders) {
    try {
      var self = this;
      $.get(
        "address.ajax.php",
        { lat: y / 1e6, lng: x / 1e6 },
        function (data) {
          try {
            if ("." != data && "no login" != data) {
              var result = eval("(" + data + ")");
              if (null != result.addr && void 0 !== result.addr) {
                element.removeClass("query_waiting");
                var ret = result.addr;
                try {
                  "text" == style
                    ? element.text(ret)
                    : "val" == style
                    ? element.val(ret)
                    : "html" == style
                    ? element.html(ret)
                    : "link" == style &&
                      element.html(
                        "<a target='_blank' href=" +
                          JS_GOOGLE_MAP_BASE_LINK +
                          "/maps?hl=en&q=" +
                          y / 1e6 +
                          "," +
                          x / 1e6 +
                          ">" +
                          ret +
                          " </a>"
                      );
                } catch (t) {}
              }
            } else if (void 0 === geocoders) {
              var url =
                "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?location=" +
                x / 1e6 +
                "," +
                y / 1e6 +
                "&f=pjson";
              $.get(url, function (data) {
                if (null != data && void 0 !== data) {
                  var result = eval("(" + data + ")");
                  if (null != result.address && void 0 !== result.address) {
                    element.removeClass("query_waiting");
                    var ret = result.address.LongLabel;
                    try {
                      "text" == style
                        ? element.text(ret)
                        : "val" == style
                        ? element.val(ret)
                        : "html" == style
                        ? element.html(ret)
                        : "link" == style &&
                          element.html(
                            "<a target='_blank' href=" +
                              JS_GOOGLE_MAP_BASE_LINK +
                              "/maps?hl=en&q=" +
                              y / 1e6 +
                              "," +
                              x / 1e6 +
                              ">" +
                              ret +
                              " </a>"
                          ),
                        self.SaveGeoName(y / 1e6, x / 1e6, ret);
                    } catch (t) {}
                  }
                }
              });
            } else {
              var geocoder = null;
              if (geocoders > 2) return;
              switch (geocoders) {
                case 0:
                  geocoder = L.Control.Geocoder.nominatim();
                  break;
                case 1:
                  geocoder = L.Control.Geocoder.arcgis();
                  break;
                case 2:
                  geocoder = L.Control.Geocoder.mapzen("search-DopSHJw");
              }
              var latlng = L.latLng(y / 1e6, x / 1e6);
              geocoder.reverse(
                latlng,
                self.wndMap.options.crs.scale(20),
                function (t) {
                  var e = t[0];
                  if (e) {
                    element.removeClass("query_waiting");
                    var i = e.name;
                    try {
                      "text" == style
                        ? element.text(i)
                        : "val" == style
                        ? element.val(i)
                        : "html" == style
                        ? element.html(i)
                        : "link" == style &&
                          element.html(
                            "<a target='_blank' href=" +
                              JS_GOOGLE_MAP_BASE_LINK +
                              "/maps?hl=en&q=" +
                              y / 1e6 +
                              "," +
                              x / 1e6 +
                              ">" +
                              i +
                              " </a>"
                          ),
                        self.SaveGeoName(y / 1e6, x / 1e6, i);
                    } catch (t) {
                      self.GeoNames(geocoders + 1);
                    }
                  }
                }
              );
            }
          } catch (t) {}
        }
      );
    } catch (t) {}
  },
  SaveGeoName: function (lat, lng, addr) {
    $.get(
      "address.ajax.php",
      { lat: lat, lng: lng, addr: addr },
      function (data) {
        if ("." == data) console.log("save address fail");
        else {
          var result = eval("(" + data + ")");
          null != result.status &&
            void 0 !== result.status &&
            "ok" == result.status &&
            console.log("save address successful");
        }
      }
    );
  },
  MoveTop: function (t) {
    null != this.lastMarker && this.lastMarker.setZIndexOffset(0),
      (this.lastMarker = t),
      t.setZIndexOffset(1e3);
  },
  NewMarker: function (
    t,
    e,
    i,
    o,
    n,
    a,
    r,
    s,
    l,
    p,
    d,
    h,
    g,
    c,
    u,
    m,
    v,
    y,
    f,
    w
  ) {
    var T = window.parent,
      x = 0,
      _ = L.latLng(a / 1e6, n / 1e6),
      b = "../img/arrow-offline.svg";
    1 == s
      ? ((b = "../img/arrow-online.svg"), (x = 1))
      : s > 1 && s < 7
      ? ((b = "../img/arrow-green.svg"), (x = 2))
      : 7 == s
      ? ((b = "../img/arrow-red.svg"), (x = 7))
      : 8 == s
      ? ((b = "../img/arrow-black.svg"), (x = 50))
      : 9 == s
      ? ((b = "../img/arrow-blue.svg"), (x = 50))
      : 10 == s
      ? ((b = "../img/arrow-green.svg"), (x = 50))
      : 11 == s
      ? ((b = "../img/arrow-gray.svg"), (x = 50))
      : 12 == s
      ? ((b = "../img/arrow-orange.svg"), (x = 50))
      : 13 == s
      ? ((b = "../img/arrow-purple.svg"), (x = 50))
      : 14 == s
      ? ((b = "../img/arrow-red.svg"), (x = 50))
      : 15 == s
      ? ((b = "../img/arrow-yellow.svg"), (x = 50))
      : 30 == s && ((b = "../img/arrow-idle.svg"), (x = 30)),
      (0 != s && 1 != s && 30 != s) || (l = 0);
    var k = L.icon({ iconUrl: b, iconSize: [28, 28], iconAnchor: [14, 14] }),
      S = "../img/icons/icon_" + r + ".svg",
      M = getIdValue("F6:", v, !0),
      F = getIdValue("F7:", v, !0),
      A = "";
    if (null != M && null != F) {
      var P =
        mileageUnitConversion(10 * parseFloat(M), T.JS_UNIT_DISTANCE) *
        (parseFloat(F) / 100);
      P > parseFloat(M) && (P = M),
        null != P &&
          (A =
            " | " +
            parseFloat(P).toFixed(0) +
            " " +
            T.UNIT_DIST +
            " | " +
            F +
            "%");
    }
    var $ =
        '<ul><li style="background: url(' +
        S +
        ') no-repeat 0px center; padding-left: 22px; background-size : 18px 18px;">' +
        e +
        " (" +
        g +
        " " +
        T.UNIT_SPEED +
        A +
        ")</li>" +
        (this.isShowDriver
          ? '<li class="popup_driver">' + (null == w ? "" : w) + "</li>"
          : '<li style="display: none;" class="popup_driver">' +
            (null == w ? "" : w) +
            "</li>") +
        "</ul>",
      E = L.marker(_, { icon: k, rotationAngle: l, draggable: !1 })
        .bindPopup(p, { offset: new L.Point(0, -10), minWidth: 340 })
        .openPopup();
    this.isShowLabels ? E.openTooltip() : E.closeTooltip(),
      (E.properties = {
        n: t,
        position: _,
        map: this.wndMap,
        tip: this.wndTip,
        clickable: !0,
        title: e,
        nc: i,
        si: o,
        content: p,
        x: n,
        y: a,
        ico: r,
        sta: s,
        dir: l,
        s: g,
        t: c,
        ts: u,
        tt: $,
        st: m,
        io: v,
        dt: y,
        jb: f,
        dn: w,
        mt: x,
      });
    var C = this;
    return (
      E.on("click", function (t) {
        C.MoveTop(E);
      }),
      void 0 !== d &&
        1 == d &&
        (this.wndMap.getBounds().contains(E.getLatLng()) ||
          this.wndMap.panTo(E.getLatLng())),
      this.MoveTop(E),
      E
    );
  },
  UpdateMarker: function (
    t,
    e,
    i,
    o,
    n,
    a,
    r,
    s,
    l,
    p,
    d,
    h,
    g,
    c,
    u,
    m,
    v,
    y,
    f,
    w
  ) {
    var T = window.parent,
      x = 0;
    t.properties.sta = s;
    var _ = "../img/arrow-offline.svg";
    1 == s
      ? ((_ = "../img/arrow-online.svg"), (x = 1))
      : s > 1 && s < 7
      ? ((_ = "../img/arrow-green.svg"), (x = 2))
      : 7 == s
      ? ((_ = "../img/arrow-red.svg"), (x = 7))
      : 8 == s
      ? ((_ = "../img/arrow-black.svg"), (x = 50))
      : 9 == s
      ? ((_ = "../img/arrow-blue.svg"), (x = 50))
      : 10 == s
      ? ((_ = "../img/arrow-green.svg"), (x = 50))
      : 11 == s
      ? ((_ = "../img/arrow-gray.svg"), (x = 50))
      : 12 == s
      ? ((_ = "../img/arrow-orange.svg"), (x = 50))
      : 13 == s
      ? ((_ = "../img/arrow-purple.svg"), (x = 50))
      : 14 == s
      ? ((_ = "../img/arrow-red.svg"), (x = 50))
      : 15 == s
      ? ((_ = "../img/arrow-yellow.svg"), (x = 50))
      : 30 == s && ((_ = "../img/arrow-idle.svg"), (x = 30));
    var b = L.icon({ iconUrl: _, iconSize: [28, 28], iconAnchor: [14, 14] });
    if (
      ((0 != s && 1 != s && 30 != s) || (l = 0),
      t.properties.s != h ||
        t.properties.title != e ||
        t.properties.ico != r ||
        getIdValue("F6:", m, !0))
    ) {
      (t.properties.title = e), (t.properties.s = h), (t.properties.ico = r);
      var k = "../img/icons/icon_" + r + ".svg",
        S = getIdValue("F6:", m, !0),
        M = getIdValue("F7:", m, !0),
        F = "";
      if (null != S && null != M) {
        var A =
          mileageUnitConversion(10 * parseFloat(S), T.JS_UNIT_DISTANCE) *
          (parseFloat(M) / 100);
        A > parseFloat(S) && (A = S),
          null != A &&
            (F =
              " | " +
              parseFloat(A).toFixed(0) +
              " " +
              T.UNIT_DIST +
              " | " +
              M +
              "%");
      }
      var P =
        '<ul><li style="background: url(' +
        k +
        ') no-repeat 0px center; padding-left: 22px; background-size : 18px 18px;">' +
        e +
        " (" +
        h +
        " " +
        T.UNIT_SPEED +
        F +
        ")</li>" +
        (this.isShowDriver
          ? '<li class="popup_driver">' + (null == f ? "" : f) + "</li>"
          : '<li style="display: none;" class="popup_driver">' +
            (null == f ? "" : f) +
            "</li>") +
        "</ul>";
      t.setTooltipContent(P), (t.properties.tt = P);
    }
    var $ = { latitude: t.properties.y / 1e6, longitude: t.properties.x / 1e6 },
      E = bearing($, { latitude: a / 1e6, longitude: n / 1e6 });
    if ((E < 0 && (E += 360), t.properties.x != n || t.properties.y != a)) {
      var C = L.latLng(a / 1e6, n / 1e6),
        D = L.latLng(t.properties.y / 1e6, t.properties.x / 1e6),
        I = this.markerCluster.getVisibleParent(t);
      if (
        !isMinStatus() &&
        this.wndMap.getBounds().contains(C) &&
        this.wndMap.getBounds().contains(D) &&
        I &&
        "_popup" in I
      ) {
        this.animationMarker[e] = t;
        var G = t.isPopupOpen();
        t.closePopup();
        var N = !1;
        0 != s && 1 != s && 30 != s && (t.setIcon(b), (N = !0));
        var O = this;
        t.setEnd(function () {
          var i = [];
          i.push(t),
            O.ToggleDriver(i, O.isShowDriver),
            t.setRotationAngle(l),
            O.MoveTop(t),
            delete O.animationMarker[e],
            G && (t.closePopup(), t.openPopup()),
            N || t.setIcon(b);
        }),
          t.slideTo(C, { duration: w || 0, rotationAngle: E });
      } else {
        t.setRotationAngle(l), t.setLatLng(C), t.setIcon(b), this.MoveTop(t);
        var R = [];
        R.push(t), this.ToggleDriver(R, this.isShowDriver);
      }
      (t.properties.x = n), (t.properties.y = a);
    } else t.setIcon(b), t.setRotationAngle(l);
    t.properties.dir != l && (t.properties.dir = l),
      t.properties.t != g && (t.properties.t = g),
      t.properties.ts != c && (t.properties.ts = c),
      t.properties.st != u && (t.properties.st = u),
      t.properties.io != m && (t.properties.io = m),
      t.properties.dt != v && (t.properties.dt = v),
      t.properties.jb != y && (t.properties.jb = y),
      t.properties.dn != f && (t.properties.dn = f),
      t.properties.nc != i && (t.properties.nc = i),
      t.properties.si != o && (t.properties.si = o),
      t.properties.mt != x && (t.properties.mt = x),
      t.properties.content != p &&
        ((t.properties.content = p), t.getPopup().setContent(p)),
      void 0 !== d &&
        1 == d &&
        (this.MoveTop(t),
        this.wndMap.getBounds().contains(t.getLatLng()) ||
          this.wndMap.panTo(t.getLatLng())),
      this.isShowLabels ? t.openTooltip() : t.closeTooltip();
  },
  StopAnimationMarker: function (t, e) {
    for (var i in this.animationMarker)
      if (null != this.animationMarker[i])
        if (t) {
          var o = this.markerCluster.getVisibleParent(this.animationMarker[i]);
          if (o && "_popup" in o) continue;
          var n = L.latLng(
            this.animationMarker[i].properties.y / 1e6,
            this.animationMarker[i].properties.x / 1e6
          );
          this.animationMarker[i].setLatLng(n),
            this.animationMarker[i].setRotationAngle(
              this.animationMarker[i].properties.dir
            ),
            this.MoveTop(this.animationMarker[i]),
            (a = []).push(this.animationMarker[i]),
            this.ToggleDriver(a, this.isShowDriver),
            delete this.animationMarker[i];
        } else {
          var a;
          n = L.latLng(
            this.animationMarker[i].properties.y / 1e6,
            this.animationMarker[i].properties.x / 1e6
          );
          if (!this.wndMap.getBounds().contains(n) || e)
            this.animationMarker[i].setLatLng(n),
              this.animationMarker[i].setRotationAngle(
                this.animationMarker[i].properties.dir
              ),
              this.MoveTop(this.animationMarker[i]),
              (a = []).push(this.animationMarker[i]),
              this.ToggleDriver(a, this.isShowDriver),
              delete this.animationMarker[i];
        }
  },
  AddLine: function (t, e, i, o, n, a, r, s) {
    if (t != i || e != o) {
      var l,
        p = [];
      return (
        (p[0] = new L.LatLng(e / 1e6, t / 1e6)),
        (p[1] = new L.LatLng(o / 1e6, i / 1e6)),
        null == s
          ? (l = new L.polyline(p, {
              color: n || this.opts_poly.strokeColor,
              opacity: r || this.opts_poly.strokeOpacity,
              weight: a || this.opts_poly.strokeWeight,
              smoothFactor: 1,
            }))
          : (this.wndMap.getZoom() > 14 ? (s -= 50) : (s -= 250),
            (l = L.motion
              .polyline(
                p,
                {
                  color: n || this.opts_poly.strokeColor,
                  opacity: r || this.opts_poly.strokeOpacity,
                  weight: a || this.opts_poly.strokeWeight,
                  smoothFactor: 1,
                },
                { auto: !0, easing: L.Motion.Ease.linear }
              )
              .motionDuration(
                s &&
                  this.wndMap.getBounds().contains(p[0]) &&
                  this.wndMap.getBounds().contains(p[1])
                  ? s
                  : 0
              )).addTo(this.wndMap)),
        l
      );
    }
    return null;
  },
  AddPoint: function (t, e, i, o, n, a, r, s, l, p, d, h, g) {
    if (
      0 == o ||
      0 == n ||
      (1 != l && 2 != l && 3 != l && 6 != l && t == o && e == n)
    )
      return null;
    var c,
      u = 0,
      m =
        1 == l || 3 == l || 6 == l
          ? new L.LatLng(e / 1e6, t / 1e6)
          : new L.LatLng(n / 1e6, o / 1e6),
      v = "";
    switch (l) {
      case 1:
        (c = L.icon({
          iconUrl: "../img/route-start.svg",
          iconSize: [28, 28],
          iconAnchor: [14, 28],
        })),
          (u = 7),
          (v += "<div class='infowindow'><ul>"),
          (v += "<h3>" + JS_START_POINT + "</h3>");
        var y = getSpeedState(1, 1, a, r, 0);
        (v +=
          a > 0
            ? "<li class='infospeed' style='padding-left: 18px; background: url(img/move.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"
            : "<li class='infospeed' style='padding-left: 18px; background: url(img/parking.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"),
          (v +=
            "<li class='infoltime'> <span>&nbsp;&nbsp;" +
            r +
            "</span></li><li class='infolocal'> <span>&nbsp;&nbsp;<a style ='color: #4D8ED9; text-decoration: none;' target='_blank' href=" +
            JS_GOOGLE_MAP_BASE_LINK +
            "/maps?hl=en&q=" +
            (n / 1e6).toFixed(5) +
            "," +
            (o / 1e6).toFixed(5) +
            ">" +
            (n / 1e6).toFixed(5) +
            " &#176;," +
            (o / 1e6).toFixed(5) +
            " &#176;</a></span></li>"),
          (v += "</ul></div>");
        break;
      case 2:
        (c = L.icon({
          iconUrl: "../img/route-end.svg",
          iconSize: [28, 28],
          iconAnchor: [14, 28],
        })),
          (u = 8),
          (v += "<div class='infowindow'><ul>"),
          (v += "<h3>" + JS_END_POINT + "</h3>");
        y = getSpeedState(1, 1, a, r, 0);
        (v +=
          a > 0
            ? "<li class='infospeed' style='padding-left: 18px; background: url(img/move.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"
            : "<li class='infospeed' style='padding-left: 18px; background: url(img/parking.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"),
          (v +=
            "<li class='infoltime'> <span>&nbsp;&nbsp;" +
            r +
            "</span></li><li class='infolocal'> <span>&nbsp;&nbsp;<a style ='color: #4D8ED9; text-decoration: none;' target='_blank' href=" +
            JS_GOOGLE_MAP_BASE_LINK +
            "/maps?hl=en&q=" +
            (n / 1e6).toFixed(5) +
            "," +
            (o / 1e6).toFixed(5) +
            ">" +
            (n / 1e6).toFixed(5) +
            " &#176;," +
            (o / 1e6).toFixed(5) +
            " &#176;</a></span></li>"),
          (v += "</ul></div>");
        break;
      case 3:
        (c = L.icon({
          iconUrl: "../img/route-stop.svg",
          iconSize: [28, 28],
          iconAnchor: [14, 28],
        })),
          (u = 4),
          (v += "<div class='infowindow'>"),
          (v += "<h3>" + JS_STOP + "</h3>"),
          (v += "<table>"),
          (v +=
            "<tr><td>" +
            JS_START +
            "</td><td style='padding-left:10px;'>" +
            p +
            "</td></tr>"),
          (v +=
            "<tr><td>" +
            JS_END +
            "</td><td style='padding-left:10px;'>" +
            d +
            "</td></tr>"),
          (v +=
            "<tr><td>" +
            JS_DURATION +
            "</td><td style='padding-left:10px;'>" +
            h +
            "</td></tr>"),
          (v += "</table></div>");
        break;
      case 4:
        (c = L.icon({
          iconUrl: "../img/waypoint_icon1.png",
          iconSize: [10, 10],
          iconAnchor: [5, 5],
        })),
          (u = 2),
          (v += "<div class='infowindow'><ul>");
        y = getSpeedState(1, 1, a, r, 0);
        (v +=
          a > 0
            ? "<li class='infospeed' style='padding-left: 18px; background: url(img/move.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"
            : "<li class='infospeed' style='padding-left: 18px; background: url(img/parking.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"),
          (v +=
            "<li class='infoltime'> <span>&nbsp;&nbsp;" +
            r +
            "</span></li><li class='infolocal'> <span>&nbsp;&nbsp;<a style ='color: #4D8ED9; text-decoration: none;' target='_blank' href=" +
            JS_GOOGLE_MAP_BASE_LINK +
            "/maps?hl=en&q=" +
            (n / 1e6).toFixed(5) +
            "," +
            (o / 1e6).toFixed(5) +
            ">" +
            (n / 1e6).toFixed(5) +
            " &#176;," +
            (o / 1e6).toFixed(5) +
            " &#176;</a></span></li>"),
          (v += "</ul></div>");
        break;
      case 5:
        (c = L.icon({
          iconUrl: "../img/waypoint_icon1.png",
          iconSize: [10, 10],
          iconAnchor: [5, 5],
        })),
          (u = 6),
          (v += "<div class='infowindow'><ul>");
        y = getSpeedState(1, 1, a, r, 0);
        (v +=
          a > 0
            ? "<li class='infospeed' style='padding-left: 18px; background: url(img/move.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"
            : "<li class='infospeed' style='padding-left: 18px; background: url(img/parking.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"),
          (v +=
            "<li class='infoltime'> <span>&nbsp;&nbsp;" +
            r +
            "</span></li><li class='infolocal'> <span>&nbsp;&nbsp;<a style ='color: #4D8ED9; text-decoration: none;' target='_blank' href=" +
            JS_GOOGLE_MAP_BASE_LINK +
            "/maps?hl=en&q=" +
            (n / 1e6).toFixed(5) +
            "," +
            (o / 1e6).toFixed(5) +
            ">" +
            (n / 1e6).toFixed(5) +
            " &#176;," +
            (o / 1e6).toFixed(5) +
            " &#176;</a></span></li>"),
          (v += "</ul></div>");
        break;
      case 6:
        (c = L.icon({
          iconUrl: "../img/route-event.svg",
          iconSize: [28, 28],
          iconAnchor: [14, 28],
        })),
          (u = 5),
          (v += "<div class='infowindow'>"),
          (v += "<h3>" + g + "</h3><ul>");
        y = getSpeedState(1, 1, a, r, 0);
        (v +=
          a > 0
            ? "<li class='infospeed' style='padding-left: 18px; background: url(img/move.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"
            : "<li class='infospeed' style='padding-left: 18px; background: url(img/parking.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"),
          (v +=
            "<li class='infoltime'> <span>&nbsp;&nbsp;" +
            r +
            "</span></li><li class='infolocal'> <span>&nbsp;&nbsp;<a style ='color: #4D8ED9; text-decoration: none;' target='_blank' href=" +
            JS_GOOGLE_MAP_BASE_LINK +
            "/maps?hl=en&q=" +
            (n / 1e6).toFixed(5) +
            "," +
            (o / 1e6).toFixed(5) +
            ">" +
            (n / 1e6).toFixed(5) +
            " &#176;," +
            (o / 1e6).toFixed(5) +
            " &#176;</a></span></li>"),
          (v += "</ul></div>");
        break;
      case 7:
        (c = L.icon({
          iconUrl: "../img/arrow-angle.svg",
          iconSize: [16, 16],
          iconAnchor: [8, 8],
        })),
          (u = 3),
          (v += "<div class='infowindow'><ul>");
        y = getSpeedState(1, 1, a, r, 0);
        (v +=
          a > 0
            ? "<li class='infospeed' style='padding-left: 18px; background: url(img/move.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"
            : "<li class='infospeed' style='padding-left: 18px; background: url(img/parking.svg) no-repeat 0px; background-size : 18px 18px;'> <span>&nbsp;&nbsp;" +
              y.spd +
              "</span></li>"),
          (v +=
            "<li class='infoltime'> <span>&nbsp;&nbsp;" +
            r +
            "</span></li><li class='infolocal'> <span>&nbsp;&nbsp;<a style ='color: #4D8ED9; text-decoration: none;' target='_blank' href=" +
            JS_GOOGLE_MAP_BASE_LINK +
            "/maps?hl=en&q=" +
            (n / 1e6).toFixed(5) +
            "," +
            (o / 1e6).toFixed(5) +
            ">" +
            (n / 1e6).toFixed(5) +
            " &#176;," +
            (o / 1e6).toFixed(5) +
            " &#176;</a></span></li>"),
          (v += "</ul></div>");
    }
    var f = L.marker(m, {
        icon: c,
        rotationAngle: 1 == u || 3 == u ? s : 0,
        draggable: !1,
      }).bindPopup(v, {
        offset: new L.Point(
          0,
          0 == u || 4 == u || 5 == u || 7 == u || 8 == u ? -25 : -5
        ),
      }),
      w = this;
    return (
      f.on("click", function (t) {
        w.MoveTop(f);
      }),
      void 0 !== u &&
        null != u &&
        (0 == u || 3 == u || 6 == u || 7 == u || 8 == u
          ? (f.addTo(this.wndMap),
            3 == u
              ? this.averagePoints.push(f)
              : 7 == u
              ? (this.startMarker = f)
              : 8 == u && (this.endMarker = f))
          : 1 == u
          ? (this.anglePoints.push(f), this.anglePointsLayer.addLayer(f))
          : 2 == u
          ? (this.timePoints.push(f), this.timePointsLayer.addLayer(f))
          : 4 == u
          ? (this.stopPoints.push(f), this.stopPointsLayer.addLayer(f))
          : 5 == u &&
            (this.eventPoints.push(f), this.eventPointsLayer.addLayer(f))),
      f
    );
  },
  AddTrackPoint: function (t, e, i, o, n, a, r, s) {
    var l = this.trackpts[t];
    if (void 0 !== l && null != l) {
      if (l.x != e || l.y != i) {
        var p,
          d,
          h,
          g,
          c = getSpeedColor(o),
          u = null;
        if (
          (null != r && void 0 !== r
            ? ((d = r.weight), (h = r.opacity), (g = r.point))
            : ((d = this.opts_poly.strokeWeight),
              (h = this.opts_poly.strokeOpacity),
              (g = this.opts_poly.point)),
          (p = this.AddLine(l.x, l.y, e, i, c, d, h, s)),
          g &&
            ((u = this.AddPoint(
              l.x,
              l.y,
              l.d,
              e,
              i,
              o,
              n,
              a,
              5
            )).setZIndexOffset(0),
            null != s && s > 0))
        ) {
          this.wndMap.removeLayer(u);
          var m = this;
          setTimeout(function () {
            for (var e = !1, i = 0; i < l.info.length; i++)
              l.info[i].point == u && (e = !0);
            m.trackpts[t] && e ? m.wndMap.addLayer(u) : m.wndMap.removeLayer(p);
          }, s - 200);
        }
        if (
          ((l.x = e),
          (l.y = i),
          (l.d = a),
          (null != p || null != u) &&
            (l.info.push({ line: p, point: u }),
            l.info.length > this.def_save_points))
        ) {
          var v = l.info.shift();
          void 0 !== v.line &&
            null != v.line &&
            (this.wndMap.removeLayer(v.line), (v.line = null)),
            void 0 !== v.point &&
              null != v.point &&
              (this.wndMap.removeLayer(v.point), (v.point = null)),
            (v = null);
        }
      }
    } else l = { x: e, y: i, d: a, info: [] };
    delete this.trackpts[t], (this.trackpts[t] = l);
  },
  DrawTrackLine: function (t, e, i, o, n, a, r, s, l, p, d) {
    (this.isShowStops = n),
      (this.isShowEvents = r),
      (this.isShowAngles = s),
      (this.isShowTimes = l),
      this.RemoveTrack(t);
    var h,
      g,
      c,
      u,
      m = { x: 0, y: 0, info: [] };
    void 0 !== i
      ? ((h = void 0 !== i.weight ? i.weight : this.opts_poly.strokeWeight),
        (g = void 0 !== i.opacity ? i.opacity : this.opts_poly.strokeOpacity),
        (c = void 0 !== i.point && i.point))
      : ((h = this.opts_poly.strokeWeight),
        (g = this.opts_poly.strokeOpacity),
        (c = !1));
    try {
      var v = null,
        y = null,
        f = [];
      if (null != p && void 0 !== p.length && p.length > 0) {
        for (var w = 0; w < p.length; w++)
          (this.tracklatLngs[p[w].GPS_TIME_START] = new L.latLng(
            p[w].LAT_START,
            p[w].LNG_START
          )),
            (this.tracklatLngs[p[w].GPS_TIME_END] = new L.latLng(
              p[w].LAT_END,
              p[w].LNG_END
            ));
        (y = p.shift()),
          (v =
            newDate(y.GPS_TIME_START).getTime() +
            (newDate(y.GPS_TIME_END).getTime() -
              newDate(y.GPS_TIME_START).getTime()) /
              2);
      }
      for (var T = [], x = 1; x < e.length; x++) {
        u = getSpeedColor(e[x].s);
        var _,
          b = null;
        if (
          ((_ = this.AddLine(
            e[x - 1].x,
            e[x - 1].y,
            e[x].x,
            e[x].y,
            u,
            h,
            g,
            d
          )),
          T.push([e[x - 1].y / 1e6, e[x - 1].x / 1e6]),
          c)
        ) {
          var k = $.format.date(e[x].tg, JS_DEFAULT_DATETIME_fmt_JS);
          if (1 == x) {
            var S = $.format.date(e[x - 1].tg, JS_DEFAULT_DATETIME_fmt_JS);
            (b = this.AddPoint(
              e[x - 1].x,
              e[x - 1].y,
              e[x - 1].d,
              e[x].x,
              e[x].y,
              e[x].s,
              S,
              e[x].d,
              1
            )),
              m.info.push({ line: null, point: b }),
              ((null != b && null == p) || void 0 === p.length) &&
                (this.tracklatLngs[e[x].tg] = b.getLatLng()),
              2 == e.length &&
                ((b = this.AddPoint(
                  e[x].x,
                  e[x].y,
                  e[x].d,
                  e[x].x,
                  e[x].y,
                  e[x].s,
                  k,
                  e[x].d,
                  2
                )),
                m.info.push({ line: null, point: b }),
                ((null != b && null == p) || void 0 === p.length) &&
                  (this.tracklatLngs[e[x].tg] = b.getLatLng()));
          } else
            x == e.length - 1 &&
              ((b = this.AddPoint(
                e[x - 1].x,
                e[x - 1].y,
                e[x - 1].d,
                e[x].x,
                e[x].y,
                e[x].s,
                k,
                e[x].d,
                2
              )),
              m.info.push({ line: null, point: b }),
              ((null != b && null == p) || void 0 === p.length) &&
                (this.tracklatLngs[e[x].tg] = b.getLatLng()));
          null != v &&
            v >= newDate(e[x - 1].tg).getTime() &&
            v <= newDate(e[x].tg).getTime() &&
            ((this.tracklatLngs[e[x].tg] = new L.latLng(
              e[x].y / 1e6,
              e[x].x / 1e6
            )),
            (v =
              null != (y = p.shift()) && void 0 !== y
                ? newDate(y.GPS_TIME_START).getTime() +
                  (newDate(y.GPS_TIME_END).getTime() -
                    newDate(y.GPS_TIME_START).getTime()) /
                    2
                : null)),
            (b = this.AddPoint(
              e[x - 1].x,
              e[x - 1].y,
              e[x - 1].d,
              e[x].x,
              e[x].y,
              e[x].s,
              k,
              e[x].d,
              4
            ));
        }
        (m.x = e[x].x),
          (m.y = e[x].y),
          (m.d = e[x].d),
          null != _ &&
            null != b &&
            (m.info.push({ line: _, point: b, time: e[x].tg, color: u }),
            f.push(b.getLatLng()));
      }
      if (
        ((this.polylineDecoratorLayer[t] = L.polylineDecorator(T, {
          patterns: [
            {
              offset: 0,
              repeat: 300,
              rotate: !1,
              symbol: L.Symbol.arrowHead({
                rotate: !1,
                pixelSize: 13,
                headAngle: 40,
                pathOptions: {
                  weight: 1,
                  fillOpacity: 1,
                  opacity: 1,
                  stroke: !0,
                  color: "white",
                  fill: !0,
                  fillColor: "#22B04B",
                  fillOpacity: 1,
                },
              }),
            },
          ],
        }).addTo(this.wndMap)),
        void 0 !== a && a.length > 0)
      )
        for (b = null, x = 0; x < a.length; x++) {
          k = $.format.date(a[x].t, JS_DEFAULT_DATETIME_fmt_JS);
          (b = this.AddPoint(
            a[x].x,
            a[x].y,
            a[x].d,
            a[x].x,
            a[x].y,
            a[x].s,
            k,
            a[x].d,
            6,
            "",
            "",
            "",
            a[x].e
          )),
            m.info.push({ line: null, point: b });
        }
      if (void 0 !== o && o.length > 0)
        for (b = null, x = 0; x < o.length; x++) {
          var M = $.format.date(o[x].START_TIME, JS_DEFAULT_DATETIME_fmt_JS),
            F = $.format.date(o[x].END_TIME, JS_DEFAULT_DATETIME_fmt_JS),
            A = o[x].DURATION_SECOND;
          (b = this.AddPoint(
            o[x].LNG,
            o[x].LAT,
            0,
            o[x].LNG,
            o[x].LAT,
            0,
            F,
            0,
            3,
            M,
            F,
            second2time(A)
          )),
            m.info.push({ line: null, point: b });
        }
      (this.trackpts[t] = m),
        (this.opts_track = {
          point: i.trackPoint || !1,
          line: i.trackLine || !0,
        }),
        this.isShowStops || this.wndMap.removeLayer(this.stopPointsLayer),
        this.isShowEvents || this.wndMap.removeLayer(this.eventPointsLayer),
        this.isShowAngles ||
          (this.wndMap.removeLayer(this.anglePointsLayer),
          this.wndMap.removeLayer(this.polylineDecoratorLayer[t])),
        this.isShowTimes || this.wndMap.removeLayer(this.timePointsLayer),
        this.ShowHideTrackLine(t, this.isRoute),
        this.isSnap && this.ToggleSnapLayer(this.isSnap),
        f.length > 0 && this.wndMap.fitBounds(f);
    } catch (t) {
      alert(t.message);
    }
  },
  LocateMarker: function (t, e, i, o, n) {
    if (
      (this.StopAnimationMarker(!1),
      (t.isPopupOpen() ||
        (void 0 !== i && 1 == i) ||
        (void 0 !== n && 1 == n)) &&
        (t.closePopup(), t.openPopup()),
      void 0 !== e &&
        1 == e &&
        ((o && this.wndMap.getBounds().contains(t.getLatLng()) && !i) ||
          this.wndMap.panTo(t.getLatLng())),
      void 0 !== i && 1 == i)
    ) {
      var a = [t.getLatLng()],
        r = L.latLngBounds(a);
      this.wndMap.fitBounds(r, {
        maxZoom: this.wndMap.getZoom() < 14 ? 14 : this.wndMap.getZoom(),
      });
    }
    this.MoveTop(t);
  },
  RemoveMarker: function (t) {
    void 0 !== t &&
      (this.lastMarker == t && (this.lastMarker = null),
      this.wndMap.removeLayer(t),
      this.markerCluster.removeLayer(t));
  },
  RemoveTrack: function (t) {
    this.anglePointsLayer.clearLayers(),
      this.timePointsLayer.clearLayers(),
      this.stopPointsLayer.clearLayers(),
      this.eventPointsLayer.clearLayers();
    var e = this.trackpts[t];
    if (void 0 !== e) {
      for (var i = 0; i < e.info.length; i++) {
        var o = e.info[i];
        void 0 !== o.line &&
          null != o.line &&
          (this.wndMap.removeLayer(o.line), (o.line = null)),
          void 0 !== o.point &&
            null != o.point &&
            (this.wndMap.removeLayer(o.point), (o.point = null));
      }
      delete this.trackpts[t];
    }
    (this.anglePoints = []),
      (this.timePoints = []),
      (this.stopPoints = []),
      (this.eventPoints = []),
      (this.averagePoints = []),
      (this.tracklatLngs = []),
      null != this.routingSnapControl &&
        (this.wndMap.removeControl(this.routingSnapControl),
        (this.routingSnapControl = null)),
      null != this.routingSnapRoute &&
        (this.wndMap.removeLayer(this.routingSnapRoute),
        (this.routingSnapRoute = null)),
      null != this.polylineDecoratorLayer[t] &&
        (this.wndMap.removeLayer(this.polylineDecoratorLayer[t]),
        (this.polylineDecoratorLayer[t] = null));
  },
  ClearTrack: function (t) {
    if (void 0 !== t) this.RemoveTrack(t);
    else {
      for (var t in this.trackpts) this.RemoveTrack(t);
      this.trackpts = [];
    }
  },
  ClearMarker: function (t) {
    for (var e in ((this.lastMarker = null), t))
      this.markerCluster.removeLayer(t[e]), delete t[e];
  },
  MarkersFitBounds: function (t) {
    var e = [];
    for (var i in t) e.push(t[i].getLatLng());
    this.wndMap.fitBounds(e);
  },
  ShowHideMovesLine: function (t, e, i, o) {
    var n = this.trackpts[t];
    if (void 0 !== n) {
      for (var a = [], r = 0; r < n.info.length; r++) {
        var s = n.info[r];
        if (
          void 0 !== s.line &&
          null != s.line &&
          void 0 !== s.point &&
          null != s.point &&
          void 0 !== s.time &&
          null != s.time &&
          void 0 !== s.color &&
          null != s.color
        ) {
          var l = s.time,
            p = s.line,
            d = s.color,
            h = s.point;
          o && newDate(l) >= newDate(e) && newDate(l) <= newDate(i)
            ? (p.setStyle({
                weight: this.opts_poly.strokeMovesWeight,
                color: this.opts_poly.strokeMovesColor,
              }),
              p.bringToFront(),
              a.push(h.getLatLng()))
            : (p.setStyle({ weight: this.opts_poly.strokeWeight, color: d }),
              p.bringToBack());
        }
      }
      this.wndMap.fitBounds(a);
    }
  },
  ShowHideTrackLine: function (t, e) {
    this.isRoute = e;
    var i = this.trackpts[t];
    if (void 0 !== i)
      for (var o = 0; o < i.info.length; o++) {
        var n = i.info[o];
        if (
          void 0 !== n.line &&
          null != n.line &&
          void 0 !== n.point &&
          null != n.point &&
          void 0 !== n.time &&
          null != n.time &&
          void 0 !== n.color &&
          null != n.color
        ) {
          var a = n.line;
          e ? a.addTo(this.wndMap) : this.wndMap.removeLayer(a);
        }
      }
    this.ShowHideAveragePoint(!e);
  },
  ShowHideAveragePoint: function (t) {
    var e = this.averagePoints;
    if (void 0 !== e)
      for (var i = 0; i < e.length; i++)
        t ? this.wndMap.removeLayer(e[i]) : e[i].addTo(this.wndMap);
  },
  HideShowMarker: function (t, e) {
    if (e) {
      for (var i in t) {
        if (this.isClusters) {
          var o = t[i].isPopupOpen();
          this.wndMap.removeLayer(t[i]),
            this.markerCluster.removeLayer(t[i]),
            this.markerCluster.addLayer(t[i]),
            o && (t[i].closePopup(), t[i].openPopup());
        } else
          this.wndMap.removeLayer(t[i]),
            this.markerCluster.removeLayer(t[i]),
            t[i].addTo(this.wndMap);
        this.showingMarkers[i] = t[i];
      }
      this.ToggleMarkerTooltip(t, this.isShowLabels);
    } else
      for (var i in t)
        t[i].unbindTooltip(),
          this.markerCluster.removeLayer(t[i]),
          this.wndMap.removeLayer(t[i]),
          this.ClearTrack(i),
          delete this.showingMarkers[i];
    this.isShowMarkers = e;
  },
  ClustersMarker: function (t) {
    if (((this.isClusters = t), t))
      for (var e in this.showingMarkers)
        this.showingMarkers[e].unbindTooltip(),
          this.wndMap.removeLayer(this.showingMarkers[e]),
          this.markerCluster.addLayer(this.showingMarkers[e]);
    else
      for (var e in this.showingMarkers)
        this.showingMarkers[e].unbindTooltip(),
          this.markerCluster.removeLayer(this.showingMarkers[e]),
          this.showingMarkers[e].addTo(this.wndMap);
    this.ToggleMarkerTooltip(this.showingMarkers, this.isShowLabels);
  },
  RefreshClusters: function () {
    this.markerCluster.refreshClusters();
  },
  ToggleMarkerTooltip: function (t, e) {
    if (e)
      for (var i in t)
        this.isShowDriver
          ? ($(t[i].properties.tt)
              .find(".popup_driver")
              .css("display", "block"),
            (t[i].properties.tt = $(t[i].properties.tt).get(0)))
          : ($(t[i].properties.tt).find(".popup_driver").css("display", "none"),
            (t[i].properties.tt = $(t[i].properties.tt).get(0))),
          t[i]
            .unbindTooltip()
            .bindTooltip(t[i].properties.tt, {
              permanent: !0,
              offset: L.point(18, 0),
              direction: "right",
            });
    else for (var i in t) t[i].unbindTooltip();
    this.isShowLabels = e;
  },
  ToggleStopLayer: function (t) {
    (this.isShowStops = t),
      t
        ? this.wndMap.addLayer(this.stopPointsLayer)
        : this.wndMap.removeLayer(this.stopPointsLayer);
  },
  ToggleEventLayer: function (t) {
    (this.isShowEvents = t),
      t
        ? this.wndMap.addLayer(this.eventPointsLayer)
        : this.wndMap.removeLayer(this.eventPointsLayer);
  },
  ToggleAngleLayer: function (t) {
    for (var e in ((this.isShowAngles = t),
    t && this.wndMap.getZoom() >= 16
      ? this.wndMap.addLayer(this.anglePointsLayer)
      : this.wndMap.removeLayer(this.anglePointsLayer),
    this.polylineDecoratorLayer))
      null != this.polylineDecoratorLayer[e] &&
        (t
          ? this.wndMap.addLayer(this.polylineDecoratorLayer[e])
          : this.wndMap.removeLayer(this.polylineDecoratorLayer[e]));
  },
  ToggleTimesLayer: function (t) {
    (this.isShowTimes = t),
      t && this.wndMap.getZoom() >= 12
        ? this.wndMap.addLayer(this.timePointsLayer)
        : this.wndMap.removeLayer(this.timePointsLayer);
  },
  ToggleDriver: function (t, e) {
    for (var i in ((this.isShowDriver = e), t))
      this.isShowDriver
        ? ($(t[i].properties.tt).find(".popup_driver").css("display", "block"),
          (t[i].properties.tt = $(t[i].properties.tt).get(0)))
        : ($(t[i].properties.tt).find(".popup_driver").css("display", "none"),
          (t[i].properties.tt = $(t[i].properties.tt).get(0))),
        this.isShowLabels &&
          t[i]
            .unbindTooltip()
            .bindTooltip(t[i].properties.tt, {
              permanent: !0,
              offset: L.point(18, 0),
              direction: "right",
            });
  },
  ResizeMapContainer: function () {
    var t = this.wndMap;
    setTimeout(function () {
      t.invalidateSize(!0);
    }, 400);
  },
  GetEventMarker: function (t) {
    return this.eventPoints[t];
  },
  GetStopMarker: function (t) {
    return this.stopPoints[t];
  },
  GetStartMarker: function () {
    return this.startMarker;
  },
  GetEndMarker: function () {
    return this.endMarker;
  },
  ToggleSnapLayer: function (t) {
    if (this.isSnaping) return !1;
    if (((this.isSnap = t), t)) {
      if (null != this.routingSnapRoute)
        this.routingSnapRoute.addTo(this.wndMap);
      else if (Object.keys(this.tracklatLngs).length > 0)
        try {
          (this.isSnaping = !0),
            (this.routingSnapControl = L.Routing.control({
              router: this.router,
              waypoints: unique(sortKey2Value(this.tracklatLngs)),
              show: !1,
              routeWhileDragging: !1,
              waypointMode: "snap",
              createMarker: function () {},
            }).addTo(this.wndMap));
          var e = this;
          this.routingSnapControl.on("routeselected", function (t) {
            (e.isSnaping = !1),
              (e.routingSnapRoute = L.polyline(t.route.coordinates, {
                color: "yellow",
              }).addTo(e.wndMap)),
              e.wndMap.removeControl(e.routingSnapControl);
          });
        } catch (t) {
          this.isSnaping = !1;
        }
    } else
      null != this.routingSnapRoute &&
        this.wndMap.removeLayer(this.routingSnapRoute);
    return !0;
  },
};
